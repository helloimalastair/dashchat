var je=Object.create;var te=Object.defineProperty;var Le=Object.getOwnPropertyDescriptor;var Ne=Object.getOwnPropertyNames;var Ue=Object.getPrototypeOf,Me=Object.prototype.hasOwnProperty;var y=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports);var $e=(r,e,s,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of Ne(e))!Me.call(r,n)&&n!==s&&te(r,n,{get:()=>e[n],enumerable:!(t=Le(e,n))||t.enumerable});return r};var re=(r,e,s)=>(s=r!=null?je(Ue(r)):{},$e(e||!r||!r.__esModule?te(s,"default",{value:r,enumerable:!0}):s,r));var se=y(C=>{"use strict";Object.defineProperty(C,"__esModule",{value:!0});C.HonoResponse=void 0;var v="Response is not finalized",V=class{constructor(e,s){this.headers=new Headers(s.headers),this.status=s.status??404,this._finalized=!1}clone(){throw new Error(v)}arrayBuffer(){throw new Error(v)}blob(){throw new Error(v)}formData(){throw new Error(v)}json(){throw new Error(v)}text(){throw new Error(v)}};C.HonoResponse=V});var j=y(g=>{"use strict";Object.defineProperty(g,"__esModule",{value:!0});g.mergePath=g.isAbsoluteURL=g.getPathFromURL=g.getPattern=g.splitPath=void 0;var ae=/^https?:\/\/[a-zA-Z0-9\-\.:]+(\/?[^?#]*)/,ne={},He=r=>{let e=ne[r];return e||(e=r.split(/\//),e[0]===""&&e.shift(),ne[r]=e,e)};g.splitPath=He;var D={},Te=r=>{if(r==="*")return"*";let e=r.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);return e?(D[r]||(e[2]?D[r]=[r,e[1],new RegExp("^"+e[2]+"$")]:D[r]=[r,e[1],!0]),D[r]):null};g.getPattern=Te;var oe={},qe=(r,e={strict:!0})=>{e.strict===!1&&r.endsWith("/")&&(r=r.slice(0,-1));let s=oe[r];if(s)return s;let t=r.match(ae);return s=t?t[1]:"",oe[r]=s,s};g.getPathFromURL=qe;var Ie=r=>!!r.match(ae);g.isAbsoluteURL=Ie;var We=(...r)=>{let e="",s=!1;for(let t of r)e.endsWith("/")&&(e=e.slice(0,-1),s=!0),t.startsWith("/")||(t=`/${t}`),t==="/"&&s?e=`${e}/`:t!=="/"&&(e=`${e}${t}`),t==="/"&&e===""&&(e="/");return e};g.mergePath=We});var N=y(L=>{"use strict";Object.defineProperty(L,"__esModule",{value:!0});L.Context=void 0;var Ke=se(),Ve=j(),J=class{constructor(e,s={env:{},event:void 0,res:void 0}){if(this._status=200,this._pretty=!1,this._prettySpace=2,this.req=this.initRequest(e),this._map={},Object.assign(this,s),!this.res){let t=new Ke.HonoResponse(null,{status:404});t._finalized=!1,this.res=t}}initRequest(e){return e.header=s=>{if(s)return e.headers.get(s);{let t={};for(let[n,o]of e.headers)t[n]=o;return t}},e.query=s=>{let t=new URL(e.url);if(s)return t.searchParams.get(s);{let n={};for(let o of t.searchParams.keys())n[o]=t.searchParams.get(o)||"";return n}},e.queries=s=>{let t=new URL(e.url);if(s)return t.searchParams.getAll(s);{let n={};for(let o of t.searchParams.keys())n[o]=t.searchParams.getAll(o);return n}},e}header(e,s){this.res.headers.set(e,s)}status(e){this._status=e}set(e,s){this._map[e]=s}get(e){return this._map[e]}pretty(e,s=2){this._pretty=e,this._prettySpace=s}newResponse(e,s={}){s.status=s.status||this._status||200;let t={};return this.res.headers.forEach((n,o)=>{t[o]=n}),s.headers=Object.assign(t,s.headers),new Response(e,s)}body(e,s=this._status,t={}){return this.newResponse(e,{status:s,headers:t})}text(e,s=this._status,t={}){if(typeof e!="string")throw new TypeError("text method arg must be a string!");return t["Content-Type"]||(t["Content-Type"]="text/plain; charset=UTF-8"),this.body(e,s,t)}json(e,s=this._status,t={}){if(typeof e!="object")throw new TypeError("json method arg must be an object!");let n=this._pretty?JSON.stringify(e,null,this._prettySpace):JSON.stringify(e);return t["Content-Type"]||(t["Content-Type"]="application/json; charset=UTF-8"),this.body(n,s,t)}html(e,s=this._status,t={}){if(typeof e!="string")throw new TypeError("html method arg must be a string!");return t["Content-Type"]||(t["Content-Type"]="text/html; charset=UTF-8"),this.body(e,s,t)}redirect(e,s=302){if(typeof e!="string")throw new TypeError("location must be a string!");if(!(0,Ve.isAbsoluteURL)(e)){let t=new URL(this.req.url);t.pathname=e,e=t.toString()}return this.newResponse(null,{status:s,headers:{Location:e}})}};L.Context=J});var ie=y(U=>{"use strict";Object.defineProperty(U,"__esModule",{value:!0});U.compose=void 0;var F=N(),Je=(r,e,s)=>async(t,n)=>{let o=-1;return a(0);async function a(i){if(i<=o)return Promise.reject(new Error("next() called multiple times"));let c=r[i];return o=i,i===r.length&&n&&(c=n),c?Promise.resolve(c(t,()=>a(i+1))).then(async u=>(u&&t instanceof F.Context&&(t.res=u,t.res._finalized=!0),t)).catch(u=>{if(t instanceof F.Context&&e)return u instanceof Error&&(t.res=e(u,t),t.res._finalized=!0),t;throw u}):(t instanceof F.Context&&t.res._finalized===!1&&s&&(t.res=await s(t),t.res._finalized=!0),Promise.resolve(t))}};U.compose=Je});var z=y(b=>{"use strict";Object.defineProperty(b,"__esModule",{value:!0});b.METHOD_NAME_ALL_LOWERCASE=b.METHOD_NAME_ALL=void 0;b.METHOD_NAME_ALL="ALL";b.METHOD_NAME_ALL_LOWERCASE="all"});var ce=y(M=>{"use strict";Object.defineProperty(M,"__esModule",{value:!0});M.Node=void 0;var Fe=z(),B=j();function ue(r,e){for(let t=0,n=r.patterns.length;t<n;t++)if(typeof r.patterns[t]=="object"&&r.patterns[t][1]===e)return!0;let s=Object.values(r.children);for(let t=0,n=s.length;t<n;t++)if(ue(s[t],e))return!0;return!1}var E=class{constructor(e,s,t){if(this.order=0,this.children=t||{},this.methods=[],e&&s){let n={};n[e]={handler:s,score:0,name:this.name},this.methods=[n]}this.patterns=[]}insert(e,s,t){this.name=`${e} ${s}`,this.order=++this.order;let n=this,o=(0,B.splitPath)(s),a=[],i=l=>`Duplicate param name, use another name instead of '${l}' - ${e} ${s} <--- '${l}'`;for(let l=0,x=o.length;l<x;l++){let m=o[l];if(Object.keys(n.children).includes(m)){a.push(...n.patterns),n=n.children[m];continue}n.children[m]=new E;let h=(0,B.getPattern)(m);if(h){if(typeof h=="object"){for(let f=0,w=a.length;f<w;f++)if(typeof a[f]=="object"&&a[f][1]===h[1])throw new Error(i(h[1]));if(Object.values(n.children).some(f=>ue(f,h[1])))throw new Error(i(h[1]))}n.patterns.push(h),a.push(...n.patterns)}a.push(...n.patterns),n=n.children[m]}let c=1;s==="*"?c=c+this.order*.01:c=o.length+this.order*.01,n.methods.length||(n.methods=[]);let u={},p={handler:t,name:this.name,score:c};return u[e]=p,n.methods.push(u),n}getHandlerSets(e,s,t){let n=[];return e.methods.map(o=>{let a=o[s]||o[Fe.METHOD_NAME_ALL];if(a!==void 0){let i={...a};t&&(i.score=a.score-1),n.push(i);return}}),n}next(e,s,t,n){let o=[],a=[],i={};for(let p=0,l=e.patterns.length;p<l;p++){let x=e.patterns[p];if(x==="*"){let w=e.children["*"];w&&(o.push(...this.getHandlerSets(w,t)),a.push(w));continue}if(s==="")continue;let[m,h,f]=x;(f===!0||f instanceof RegExp&&f.test(s))&&(typeof m=="string"&&(n===!0&&o.push(...this.getHandlerSets(e.children[m],t)),a.push(e.children[m])),typeof h=="string"&&(i[h]=s))}let c=e.children[s];return c&&(n===!0&&(c.children["*"]&&o.push(...this.getHandlerSets(c.children["*"],t,!0)),o.push(...this.getHandlerSets(c,t))),a.push(c)),{nodes:a,handlerSets:o,params:i}}search(e,s){let t=[],n={},a=[this],i=(0,B.splitPath)(s);for(let u=0,p=i.length;u<p;u++){let l=i[u],x=u===p-1,m=[];for(let h=0,f=a.length;h<f;h++){let w=this.next(a[h],l,e,x);w.nodes.length!==0&&(t.push(...w.handlerSets),n={...n,...w.params},m.push(...w.nodes))}a=m}return t.length<=0?null:{handlers:t.sort((u,p)=>u.score-p.score).map(u=>u.handler),params:n}}};M.Node=E});var de=y($=>{"use strict";Object.defineProperty($,"__esModule",{value:!0});$.TrieRouter=void 0;var ze=ce(),G=class{constructor(){this.node=new ze.Node}add(e,s,t){this.node.insert(e,s,t)}match(e,s){return this.node.search(e,s)}};$.TrieRouter=G});var le=y(H=>{"use strict";Object.defineProperty(H,"__esModule",{value:!0});H.TrieRouter=void 0;var Be=de();Object.defineProperty(H,"TrieRouter",{enumerable:!0,get:function(){return Be.TrieRouter}})});var me=y(T=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0});T.Hono=void 0;var Ge=ie(),Ye=N(),he=z(),Xe=le(),pe=j(),Ze=["get","post","put","delete","head","options","patch"];function Qe(){return class{}}var Y=class extends Qe(){constructor(e={}){super(),this.router=new Xe.TrieRouter,this.strict=!0,this._tempPath="",this.path="/",this.routes=[],this.notFoundHandler=async t=>{let n="404 Not Found";return t.text(n,404)},this.errorHandler=(t,n)=>{console.error(`${t.stack||t.message}`);let o="Internal Server Error";return n.text(o,500)},[...Ze,he.METHOD_NAME_ALL_LOWERCASE].map(t=>{this[t]=(n,...o)=>(typeof n=="string"?this.path=n:this.addRoute(t,this.path,n),o.map(a=>{typeof a!="string"&&this.addRoute(t,this.path,a)}),this)}),Object.assign(this,e)}route(e,s){return this._tempPath=e,s&&(s.routes.map(t=>{this.addRoute(t.method,t.path,t.handler)}),this._tempPath=""),this}use(e,...s){return typeof e=="string"?this.path=e:s.unshift(e),s.map(t=>{this.addRoute(he.METHOD_NAME_ALL,this.path,t)}),this}onError(e){return this.errorHandler=e,this}notFound(e){return this.notFoundHandler=e,this}addRoute(e,s,t){e=e.toUpperCase(),this._tempPath&&(s=(0,pe.mergePath)(this._tempPath,s)),this.router.add(e,s,t);let n={path:s,method:e,handler:t};this.routes.push(n)}matchRoute(e,s){return this.router.match(e,s)}async dispatch(e,s,t){let n=(0,pe.getPathFromURL)(e.url,{strict:this.strict}),o=e.method,a=this.matchRoute(o,n);e.param=l=>a?l?a.params[l]:a.params:null;let i=a?a.handlers:[this.notFoundHandler],c=new Ye.Context(e,{env:t,event:s});c.notFound=()=>this.notFoundHandler(c);let u=(0,Ge.compose)(i,this.errorHandler,this.notFoundHandler),p;try{p=await u(c)}catch(l){if(l instanceof Error)return this.errorHandler(l,c);throw l}return p.res}async handleEvent(e){return this.dispatch(e.request,e)}async fetch(e,s,t){return this.dispatch(e,t,s)}request(e,s){let t=e instanceof Request?e:new Request(e,s);return this.dispatch(t)}fire(){addEventListener("fetch",e=>{e.respondWith(this.handleEvent(e))})}};T.Hono=Y});var fe=y(O=>{"use strict";Object.defineProperty(O,"__esModule",{value:!0});O.Context=O.Hono=void 0;var et=me();Object.defineProperty(O,"Hono",{enumerable:!0,get:function(){return et.Hono}});var tt=N();Object.defineProperty(O,"Context",{enumerable:!0,get:function(){return tt.Context}})});var ge=y(q=>{"use strict";Object.defineProperty(q,"__esModule",{value:!0});q.cookie=void 0;var rt=()=>async(r,e)=>{r.req.cookie=s=>{let t=r.req.headers.get("Cookie")||"",n=st(t);return s?n[s]:n},r.cookie=(s,t,n)=>{let o=nt(s,t,n);r.header("Set-Cookie",o)},await e()};q.cookie=rt;var st=r=>{let e=r.split(/;\s*/g),s={};for(let t=0,n=e.length;t<n;t++){let o=e[t].split(/\s*=\s*([^\s]+)/);s[o[0]]=decodeURIComponent(o[1])}return s},nt=(r,e,s={})=>{e=encodeURIComponent(e);let t=`${r}=${e}`;return s.maxAge&&(t+=`; Max-Age=${Math.floor(s.maxAge)}`),s.domain&&(t+="; Domain="+s.domain),s.path&&(t+="; Path="+s.path),s.expires&&(t+="; Expires="+s.expires.toUTCString()),s.httpOnly&&(t+="; HttpOnly"),s.secure&&(t+="; Secure"),s.sameSite&&(t+=`; SameSite=${s.sameSite}`),t}});var Ce=re(fe(),1),De=re(ge(),1);var ye=(r=21)=>crypto.getRandomValues(new Uint8Array(r)).reduce((e,s)=>(s&=63,s<36?e+=s.toString(36):s<62?e+=(s-26).toString(36).toUpperCase():s>62?e+="-":e+="_",e),"");var I=new TextEncoder,we=new TextDecoder;var Se=r=>Math.floor(crypto.getRandomValues(new Uint32Array(1))[0]/(4294967295+r)),Re=r=>()=>r[Se(r.length)],xe=()=>{let r=Re("aeiou"),e=Re("bcdfghjklmnpqrstvwxyz"),s="";for(let t=0;t<10;t++)s+=t%2==Se(1)?e():r();return s},W=r=>r.split("").map(e=>e.charCodeAt(0).toString(16)).join("");var P=/^[a-zA-Z0-9\-\_]{5,50}$/;var d=(r,e)=>new Response(r,{status:e||400}),_=()=>d("Username does not exist");async function ve(r,e){let s=await fetch(`https://api.cloudflare.com/client/v4/accounts/${e.CFAccountID}/stream?direct_user=true`,{method:"POST",headers:{authorization:e.CFAPIToken,"upload-length":"21600","tus-resumable":"1.0.0","upload-metadata":`allowedOrigins WyJkYXNoY2hhdC5hcHAiXQ==,creator ${btoa(r)},requireSignedUrls`}}),t=s.headers.get("stream-media-id"),n=s.headers.get("location");if(!t||!n)throw new Error("Cloudflare API returned an invalid response");let o=W(t);return await e.KV.put(`${e.KVPrefix}-ProcessingComplete-${o}`,"false"),{url:n,id:o}}var be=async(r,e)=>{if(r.req.headers.get("content-type")!=="application/json")return await e(),r.res;let s=r.req.headers.get("Webhook-Signature"),t=await r.req.text();if(!s)return await e(),r.res;let n;try{let o=Object.fromEntries(s.split(",").map(u=>u.split("="))),a=`${o.time}.${t}`,i=await crypto.subtle.importKey("raw",I.encode(r.env.StreamWebhookSecret),{name:"HMAC",hash:{name:"SHA-512"}},!1,["sign"]);if(we.decode(await crypto.subtle.sign("HMAC",i,I.encode(a)))!==o.sig1)throw new Error("");n=JSON.parse(t)}catch{return await e(),r.res}return await r.env.KV.put(`${r.env.KVPrefix}-ProcessingComplete-${W(n.uid)}`,"true"),r.text("OK")},Oe=async r=>{let e=await r.env.KV.get(`${r.env.KVPrefix}-ProcessingComplete-${r.req.param("id")}`,{type:"json"});return e===null?(r.status(404),r.text("Video ID not recognized")):r.text(e?"true":"false")};var _e=async r=>{if(r.req.headers.get("content-type")!=="application/json")return d('Content-Type must be "application/json"');let e;try{e=await r.req.json()}catch{return d("Body must be valid JSON")}let s=r.req.cookie("uname");if(!s)return _();if(!P.test(s))return d("Username did not pass regex");if(!e.roomName)return d("No room name provided");if(!P.test(e.roomName))return d("Room name did not pass regex");let t=r.req.cookie("userId")||ye(),n=xe(),o=r.req.cf?.continent==="EU",a=o?{jurisdiction:"EU"}:void 0,i=r.env.ROOMS.newUniqueId(a);return await r.env.KV.put(`${r.env.KVPrefix}-${n}`,JSON.stringify({status:"open",owner:t,doId:i.toString()})),await r.env.ROOMS.get(i).fetch(new Request(r.env.InternalURL+"/startup",{body:JSON.stringify({external:n,isGDPR:o,owner:t,name:e.roomName,videoLength:e.videoLength})})),r.cookie("userId",t,{httpOnly:!0,maxAge:31622400,sameSite:"Strict",secure:!0}),r.json({external:n,isGDPR:o,uploadLink:ve(t,r.env)})};var Ee=async r=>{let e=await r.req.text();return P.test(e)?(r.cookie("uname",e,{maxAge:31622400,sameSite:"Strict",secure:!0}),r.text("OK")):d("Username did not pass regex")};var Pe=async(r,e)=>{let s=r.req.headers.get("Upgrade");if(!s||s!=="websocket")return fetch(r.req);if(!r.req.cookie("uname"))return _();let t=await r.env.KV.get(`${r.env.KVPrefix}-rooms-${r.req.param("id")}`,{type:"json"});if(!t)return d("Room does not exist",404);if(t.status!=="open")return d(`Room is ${t.status}`,403);let n=new Request(`${r.env.InternalURL}/connect`,r.req);return t.ids.owner===r.req.cookie("userId")&&n.headers.set("isOwner","true"),n.headers.set("uname",r.req.cookie("uname")),await r.env.ROOMS.get(r.env.ROOMS.idFromString(t.ids.do)).fetch(n)};async function X(r){if(!r.ids.external)return!1;let e={room:r.ids.external,data:r.connections.reduce((s,t)=>(t.location&&(s[t.location]=(s[t.location]||0)+1),s),{})};return await r.env.ANALYTICS.get(r.env.ANALYTICS.idFromName("analytics")).fetch(new Request(JSON.stringify(e))),!0}async function k(r,e="Room deleted"){r.connections.forEach(s=>s.ws.close(1001,e)),r.connections=[],r.owner=void 0}async function K(r,e,s){r.connections.forEach(t=>{t.uname!==s&&t.ws.send(e)})}async function A(r,e){return r.ids.external?(r.status=e,await r.env.KV.put(`${r.env.KVPrefix}-${r.ids.external}`,JSON.stringify({status:r.status,ownerId:r.ids.external,doId:r.ids.do})),!0):!1}var ot=new TextDecoder,S=r=>JSON.stringify({time:Date.now(),type:"error",message:r}),ke=r=>JSON.stringify({time:Date.now(),type:"system",message:r});async function Z(r,e,s){let t;try{typeof s.data=="string"?t=JSON.parse(s.data):t=JSON.parse(ot.decode(s.data))}catch{return e.ws.send("Invalid/Unparseable JSON")}if(t.message)return r.log.push({time:Date.now(),user:e.uname,message:t.message}),e.ws.send(JSON.stringify({time:Date.now(),type:"message",message:t.message}));switch(t.command){case"delete":if(!e.isOwner)return e.ws.send(S("Unauthorized. Must be owner to use commands."));await Promise.all([k(r),r.storage.deleteAll(),r.env.KV.delete(`${r.env.KVPrefix}-${r.ids.external}`)]);return;case"end":if(!e.isOwner)return e.ws.send(S("Unauthorized. Must be owner to use commands."));await A(r,"ended"),await k(r,"Room ended."),r.log.push({time:Date.now(),user:e.uname,command:"end"}),await r.storage.setAlarm(Date.now()+6e4);return;case"lock":return e.isOwner?r.status==="locked"?e.ws.send(S("Error: Room is already locked")):(await A(r,"locked"),r.log.push({time:Date.now(),user:e.uname,command:"lock"}),e.ws.send(ke("Room is now locked."))):e.ws.send(S("Unauthorized. Must be owner to use commands."));case"unlock":return e.isOwner?r.status!=="locked"?e.ws.send(S("Error: Room is already unlocked")):(r.connections.length<r.maxOccupants?await A(r,"open"):await A(r,"at capacity"),r.log.push({time:Date.now(),user:e.uname,command:"unlock"}),e.ws.send(ke("Room is now unlocked."))):e.ws.send(S("Unauthorized. Must be owner to use commands."));case"start":case"stop":case"skipTo":if(!t.timestamp)return e.ws.send(S("Error. Must have a timestamp."));let n=Date.now();r.log.push({time:n,user:e.uname,command:t.command,timestamp:t.timestamp}),K(r,JSON.stringify({time:n,type:"control",command:t.command,timestamp:t.timestamp}),e.uname)}}var at=(r,e)=>K(r,`User ${e.uname} has disconnected.`,"[SYSTEM]"),Ae=at;var Q=class{ids;storage;blockConcurrencyWhile;env;owner;connections=[];maxOccupants;log=[];status="open";isGDPR=!0;videoLength;videoReady=!1;constructor(e,s){this.ids={do:e.id.toString()},this.storage=e.storage,this.blockConcurrencyWhile=e.blockConcurrencyWhile,this.env=s,this.maxOccupants=Number(s.MaxOccupants),this.blockConcurrencyWhile(async()=>{let t=await this.storage.get("status");t&&(this.status=t)})}async connect(e){if(this.status!=="open")return d(`Room is ${this.status}`,503);let s=e.headers.get("uname"),t=Boolean(e.headers.get("isOwner"));if(!s)return _();if(t&&this.connections.find(i=>i.isOwner))return d("Owner already connected");if(this.connections.find(i=>i.uname===s))return d("Username already connected");let[n,o]=Object.values(new WebSocketPair);o.accept();let a={uname:s,isOwner:t,location:e.cf?.country,ws:o};if(o.addEventListener("message",async i=>Z(this,a,i)),o.addEventListener("close",()=>Ae(this,a)),a.isOwner&&(this.owner=a),this.connections.push(a),this.connections.length>=this.maxOccupants){if(this.status="at capacity",!this.ids.external)return d("Room has not been initiated",500);await this.env.KV.put(`${this.env.KVPrefix}-${this.ids.external}`,JSON.stringify({status:this.status,ownerId:this.ids.external,doId:this.ids.do}))}return new Response("Upgrade in progress",{status:101,webSocket:n})}async fetch(e){switch(new URL(e.url).pathname){case"/startup":let t=await e.json();return this.ids.external=t.external,this.ids.owner=t.owner,this.ids.name=t.name,this.isGDPR=t.isGDPR,this.videoLength=t.videoLength,t.maxOccupants&&(this.maxOccupants=t.maxOccupants),await this.storage.setAlarm(Date.now()+6e4),new Response("OK");case"/ready":return this.videoReady=!0,new Response("OK");case"/delete":return await k(this),await this.storage.deleteAll(),new Response("Room deleted",{status:200});case"/connect":return this.videoReady?this.connect(e):d("Video has not finished processing")}return new Response("Invalid Internal URL",{status:404})}async alarm(){if(this.status==="ended")return await this.env.KV.put(`${this.env.KVPrefix}-${this.ids.external}-log`,JSON.stringify(this.log),{metadata:{owner:this.ids.owner}}),await this.storage.deleteAll();await this.storage.put("log",this.log),X(this),await this.storage.setAlarm(Date.now()+6e4)}};var ee=class{blockConcurrencyWhile;storage;prefix;kv;data;constructor({blockConcurrencyWhile:e,storage:s},{KVPrefix:t,KV:n}){this.blockConcurrencyWhile=e,this.storage=s,this.prefix=t,this.kv=n,this.blockConcurrencyWhile(async()=>{let o=await this.storage.get("data");this.data=o||{},await this.storage.setAlarm(Date.now()+6e4)})}alarm(){this.blockConcurrencyWhile(async()=>{this.data||(this.data=await this.storage.get("data")||{});let e,s;e=s=0;let t=Object.values(this.data).reduce((o,a)=>(Object.entries(a).forEach(i=>{o[i[0]]=(o[i[0]]||0)+i[1],s++}),e++,o),{}),n={countries:t,rooms:e,occupants:s,timestamp:Date.now()};this.data={},await Promise.all([this.storage.delete("data"),this.kv.put(`${this.prefix}-analytics`,JSON.stringify({ret:n}))]),await this.storage.setAlarm(Date.now()+6e4)})}async fetch(e){this.data||(this.data=await this.storage.get("data")||{});let{room:s,data:t}=await e.json();return this.data[s]=t,this.storage.put("data",this.data),new Response(null,{status:204})}};var R=new Ce.Hono;R.use("*",(0,De.cookie)());R.get("/hello",r=>r.text("Hello World!"));R.get("/identify",Ee);R.post("/create",_e);R.get("/processing/:id",Oe);R.all("/processing/complete",be);R.get("/rooms/:id",Pe);R.notFound(async({req:r})=>await fetch(r));var gr=R;export{ee as Analytics,Q as Room,gr as default};
//# sourceMappingURL=worker.js.map
